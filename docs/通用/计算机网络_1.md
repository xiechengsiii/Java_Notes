##   																																																											网络层 

- 网络层提供的两种服务     虚电路服务    /   数据报服务

  比较：![image-20200626101603300](E:\Typora\imgs\image-20200626101603300.png)

  现在都是用的**数据报服务**

##### 网络互连的设备

  中间设备又称中间系统或者**中继系统**

  - 物理层中继系统           **转发器**

  - 数据链路层中继系统     **网桥或交换机**

  - 网络层    **路由器 ** 

    注意，路由器的总是有两个或者两个以上的IP地址。并且每个接口的IP地址的网络号是不同的。

    路由器的一个接口相当于一个网卡，有IP地址和MAC地址

  - 网络层以上的    **网关**  （不过我们现在大部分所说的“网关”是指路由器上的接口地址，并不是指原始定义的网络层以上的网关）

    ​	

    ​	我们看网络好不好，首先会 ping 网关，就是路由器那个接口的地址

    <img src="E:\Typora\imgs\image-20200626102840311.png" alt="image-20200626102840311" style="zoom:67%;" />

一般来说，设置网关都是设置本网段的第一个地址或者最后一个地址（1或者254）,防止和计算机的IP地址重复

<font color=#FF0000>主机字段不能全为1和0，全0代表网段，全1代表一个广播信号</font>

##### IP协议简介

​	RIP OSPF  BGP 都属于IP协议

- 网际协议IP是TCP/IP体系中两个最主要的协议之一。与IP协议配套使用的还有4个协议：

  - 地址解析协议 ARP
  - 逆地址解析协议 RARP
  - 网际控制报文协议 ICMP
  - 网际组管理协议  IGMP   管理组播的

- 网络层四个协议之间的层次![image-20200626103808189](E:\Typora\imgs\image-20200626103808189.png)

  ARP层次最低，IP协议是要依赖于ARP协议工作的，ICMP, IGMP层次稍高，都是依赖于IP协议工作的。

### IP层次结构

##### 	网络地址
 ![image-20200626105051268](E:\Typora\imgs\image-20200626105051268.png)

![image-20200626110246240](E:\Typora\imgs\image-20200626110246240.png)

  ![image-20200626110319854](E:\Typora\imgs\image-20200626110319854.png)

- 几个特殊的地址

  - 127.0.0.1   本地环回地址

  - 169.254.0.0  windows系统IP地址设置成自动分配后，无法获得自动分配地址时自动产生的临时地址

    ![image-20200627231225051](E:\Typora\imgs\image-20200627231225051.png)

  保留的私网地址

  ​    在互联网上，这些地址没有被服务器使用，可以让企业/学校内的内部人员来是使用

  ![image-20200627231211023](E:\Typora\imgs\image-20200627231211023.png)

  ​		分别对应A类， B类，C类地址
##### 子网掩码

​	![image-20200626112638162](E:\Typora\imgs\image-20200626112638162.png)

子网掩码的作用： **将某个IP地址划分成网络地址和主机地址两个部分** , 与运算后主机位会归零 eg:

```java
计算机A：
    IP:192.168.80.123
    子网掩码：255.255.255.0
    网关：192.168.80.1
        
计算机B：
    IP：192.168.90.128
 如果A想和B通信， A将自己的IP & 子网掩码 判断出网段 = 192.168.80
        		然后拿B的IP & 子网掩码   得到网段 = 192.168.90
        		不在同一个网段，那么就会将数据报发送给路由网关，进行转发;
如果A的子网掩码是255.255.0.0,那么拿掩码分别于A的IP ，B的IP进行与运算可以得到A,B在同一个网段192.168,
那么发送数据的时候就不会经过网关而直接发送
```

##### 子网划分

​	目的是为了充分利用ip地址，解决IP地址数量不够的问题

![image-20200626114957534](E:\Typora\imgs\image-20200626114957534.png)

现在网关可不是255.255.255.0了，而是255.255.255.128,相当于在将原先的网段等分了两 个子网

分成 四个子网：![image-20200626135526358](E:\Typora\imgs\image-20200626135526358.png)

子网划分不是随便划分的：每次都是对半划分

有子网的拆分，还有子网的合并--超网

##### IP地址与MAC地址

​	有了MAC地址为什么还要IP地址呢？

​	IP地址决定了数据包的起点和终点，MAC地址决定了数据帧的下一跳由哪个设备接收

![image-20200626185004487](E:\Typora\imgs\image-20200626185004487.png)

##### ARP协议

<img src="E:\Typora\imgs\image-20200626191902660.png" alt="image-20200626191902660" style="zoom:67%;" />

- ARP简介

  不管网络层使用什么协议，在实际网络的链路上传输数据帧时，最终还是需要用到物理地址。

  每个主机都有一个APR高速缓存，里面有所有局域网上各主机和路由器的IP到硬件地址的映射表。

  当主机A向B发送IP数据报时，就先在主机A的**ARP Cache**查看有无B的IP地址，如果有，就可查出其MAC地址，然后写入MAC帧，然后通过局域网将该帧发送至该硬件地址。

  我有个问题：是如何查到中间设备的mac地址呢?

  我觉得：首先找网关，从对应的路由器的路由表找到下一个网关应该是多少，然后可以解析对应的MAC地址

- ARP欺骗	 

  原理就是告诉你一个错误的MAC地址或者第三方机器的MAC地址，然后你发送的数据包就会发送至第三方机器而造成泄密。

##### IP数据报（数据包）

- 一个IP数据包由首部和数据两部分组成

  - 首部的前一部分是固定长度，20个字节，所有IP数据包必须有的
  - 首部的固定部分的后面是一些可选字段，长度可变

  <img src="E:\Typora\imgs\image-20200626192742610.png" alt="image-20200626192742610" style="zoom:67%;" />

![image-20200626192818647](E:\Typora\imgs\image-20200626192818647.png)

- 版本  IPV4?IPV6?

- 首部长度    

  占4位。可以表示的最大数值是15个单位（一个单位 = 4字节），因此IP数据包的首部长度最大为60字节

- 区分服务 

  在数据包上打一个标记。说明这个数据包是着急？不着急？

- 总长度  

  16位。只首部和数据之和的长度。因此数据包的最大长度为65535字节。总长度不能超过最大传输单元MTU（1500字节）。

- 标识

  一个计数器。用来产生数据包的标识，不是序号，每产生一个数据包，就增加1

- 标记

  整包还是分片后的包？ 为啥要分片？比如你数据包大3800字节，超过MTU，所以需要分片。因此有个标记位来标记

- 片偏移

  分组在分片后某片在原分组中的相对位置。片偏移以8个字节为偏移单位

- 生成时间 TTL

  数据包在网络中可以通过的路由器数的最大值

- 协议

  数据包携带的数据使用何种协议，以便目的主机将数据部分上交给哪个处理过程

  <img src="E:\Typora\imgs\image-20200626194934308.png" alt="image-20200626194934308" style="zoom:67%;" />

- 校验和  只校验首部不校验数据部分

- 可变部分

  ![image-20200626195330425](E:\Typora\imgs\image-20200626195330425.png)

#####  路由

​	路由器在不同网段换发数据包。

​	典型的路由结构：<img src="E:\Typora\imgs\image-20200627220820654.png" alt="image-20200627220820654" style="zoom: 67%;" />

​	网络畅通：数据包必须来回都没有问题。

​	![image-20200626201836808](E:\Typora\imgs\image-20200626201836808.png)

##### 网络负载均衡

##### ICMP

​	为了提高IP数据包交付成功的机会，在网络层使用网际控制报文协议

- ICMP允许主机或路由器报告差错情况和提供有关异常的报告

- ICMP报文作为IP数据包的数据，加上数据包的首部，组成IP数据包发送出去

  <img src="E:\Typora\imgs\image-20200626210203319.png" alt="image-20200626210203319" style="zoom:67%;" />

###### 类型![image-20200626205859286](E:\Typora\imgs\image-20200626205859286.png)



##### ``pathping``是一个很有用的命令：

![image-20200626211932631](E:\Typora\imgs\image-20200626211932631.png)

##### 动态路由协议

下面几个协议都是动态路由协议

- RIP  

  周期性广播（30s） 。选择最佳路径的依据是经过的跳数最少

- OSPF协议   内部网关协议  同一个自治系统内部都使用相同的路由协议

  选择最佳路径的依据是带宽

  触发式更新  ： 三个表

  - 邻居表  发hello包
  - 链路状态表
  - 计算路由表

- BGP  外部网关协议

  ![image-20200627220122706](E:\Typora\imgs\image-20200627220122706.png)

<img src="E:\Typora\imgs\image-20200627220231315.png" alt="image-20200627220231315" style="zoom: 67%;" />

相当于AS之间的路由：![image-20200627220346171](E:\Typora\imgs\image-20200627220346171.png)

BGP所交换的网络可达性的信息就是要到达某一个网络所要经过的一系列AS.

当BGP发言人互相交换了网络可达性的信息之后，各BGP发言人根据所采用的策略从收到的路由信息中找到到达各自AS的较好路由。

##### 网络地址转换技术  NAT  PAT  

​	实际生活中用的挺多的，再查下

​	能够实现一堆的计算使用同一个IP地址访问internet。出去的时候数据包的流量都是由这个公网IP地址收发的。

通过这个技术，IPV4才能用到今天，不然IPv4的地址早就用完了。我们私网的计算机能访问公网，公网的计算机进不来。NAT严格意义上不节省IP地址：比如路由器上有十个公网IP地址，只能允许10台计算机能上网，当连11台时，没有地址可以更换了就无法访问公网了。真正节省公网地址的是PAT协议，可以把计算机的端口替换，这样就可以一个地址多个机器共同上网。

​	所以NAT和PAT的区别: NAT替换IP地址，PAT替换端口

​	做了地址转换之后，要让互联网上的计算机访问内网，还需要做**端口映射**。比如一个私网内A,B,C,D的计算机使用同样的端口x, 那么外网计算机访问这些私网内的机器需要连那个公网地址  + 端口号，比如10.7.86.4:4000, 映射私网内的A:x,  10.7.86.4:4001映射成B ：x， 10.7.86.4:4002 映射成C:x,这样就可以通过访问公网IP ： 不同的端口号  ,通过端口映射连接到私网内的不同计算机。 

<img src="E:\Typora\imgs\image-20200627231749342.png" alt="image-20200627231749342" style="zoom:80%;" />

##### VPN    

​	可以实现远程网络通过VPN服务器连到内网

![image-20200627224815809](E:\Typora\imgs\image-20200627224815809.png)

这就相当于在公网上传私有数据/进行私密通信

<img src="E:\Typora\imgs\image-20200627231529964.png" alt="image-20200627231529964" style="zoom: 67%;" />

​											配置好两端的VPN服务器即可

你是公网IP，如果通过VPN后再访问其他服务器，是先走VPN服务器，然后再走到目的服务器。在目的服务器看来，数据的来源是VPN服务器的IP。 VPN翻墙原理就是类似的。 

## 传输层

传输层为相互通信的应用进程提供了逻辑通信

网络层是地址到地址， 传输层是进程到进程

![image-20200701103758538](E:\Typora\imgs\image-20200701103758538.png)

​	 通过 TCP/UDP + 端口号 找到对应的应用程序

协议栈：

![image-20200630085604414](E:\Typora\imgs\image-20200630085604414.png)

- TCP

  应用场景：需要将传输的文件分段，  传输需要建立会话，  可靠传输 流量控制

- UDP

  应用场景：一个数据包就能够完成数据通信就可以用UDP， 不分段， 不需要建立会话，不进行流量控制  不可靠传输  还用于多播 ， 广播
---

传输层协议和应用层之间的关系

  常见的应用层协议使用的的端口：

  http = tcp + 80            https  = tcp + 443     ftp = tcp + 21          smtp  =  tcp + 25

DNS  = udp + 53   	sql = tcp + 1433

服务使用TCP或者UDP的端口侦听客户端的请求，客户端使用IP地址定位服务器，使用目标端口定位服务

可以在服务器网卡上设置只开放必要的端口实现服务器网络安全

测试远程某个计算机是否打开： telnet 192.168.80.100 3389

端口就是对应着服务。可以通过改端口号来增加网络完全。比如你攻击21端口的FTP服务，但是这个端口根本就不是FTP服务。

- 所以让服务器更加安全呢？

  网卡上只设置必要的端口，比如你是web服务器，只提供web服务，那么你网卡上只需要开80端口，那么其他人只能访问你的web服务。

---

#### UDP

- 无连接
- 尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制
- 面向报文。没有拥塞控制，很适合多媒体通信的要求
- 支持一对一，一对多，多对1，多对多的交互通信
- 首部开销小，只有8个字节。

##### 首部格式

​	<img src="E:\Typora\imgs\image-20200701152258290.png" alt="image-20200701152258290" style="zoom:80%;" />

#### TCP

- 面向连接
- 每一条TCP连接只能有两个端点（endpoint），每一条tcp连接只能是点对点的
- 提供可靠交付的服务
- 提供全双工通信
- 面向字节流 

##### 端口

​	用一个16位标记（0 -- 65535），只具有本地意义，是为了标记本计算机的各应用进程。本地计算机的端口号不能重。	

- 熟知端口（一般0-1023）

  ftp 21  http 80   telnet 23   smtp 25    dns 53   https 443   rdp 3389

- 登记端口   1024-49151

- 客户端端口  49152-65535

TCP连接端点不是主机，不是主机的IP地址，不是应用进程，而是套接字。端口号拼接到IP地址即构成了套接字

传输之前，会将要传输的数据放到缓冲区，对应接受方也有缓冲区，接受的数据先进入缓冲区

##### 如何实现可靠传输

<img src="E:\Typora\imgs\image-20200702154949935.png" alt="image-20200702154949935" style="zoom: 50%;" />

<img src="E:\Typora\imgs\image-20200702155133524.png" alt="image-20200702155133524" style="zoom:67%;" />

<img src="E:\Typora\imgs\image-20200702154011742.png" alt="image-20200702154011742" style="zoom: 50%;" />

停止等待协议的优点是简单，但是信道利用率太低。<img src="E:\Typora\imgs\image-20200702155606724.png" alt="image-20200702155606724" style="zoom:80%;" />

发送数据包时间TD , 接受时间TA，发送时间占总时间太短了， 大部分时间都浪费了RTT上。

$$	信道利用率 U  = Td/(Td  + RTT + Ta)$$		

可以是发送方连续发送多个分组，不必没发完一个数据包就停顿下来等待对方的确认。由于信道上一直有数据不间断地传输，这种运输方式可以获得很高的信道利用率。

<img src="E:\Typora\imgs\image-20200702160159225.png" alt="image-20200702160159225" style="zoom:67%;" />

通过滑动窗口来实现流水线传输：<img src="E:\Typora\imgs\image-20200702162915104.png" alt="image-20200702162915104" style="zoom:50%;" />



收到了1的确认之后，窗口往右移动 - --  每收到窗口第一个序号对应的确认后，窗口就往右移动

还有**累积确认**

###### 实现可靠传输详解

- 以字节为单位的滑动窗口

   阶段1

<img src="E:\Typora\imgs\image-20200702205317673.png" alt="image-20200702205317673" style="zoom: 50%;" />

​		阶段2

<img src="E:\Typora\imgs\image-20200702210342090.png" alt="image-20200702210342090" style="zoom:50%;" />

​					B发送ack = 7， B的接收窗口也会往右移动6个字节；A接受到ack = 7， 往右移动6个字节

- 超时重传时间的选择

  <img src="E:\Typora\imgs\image-20200702211543675.png" alt="image-20200702211543675" style="zoom:80%;" />

##### 如何实现流量控制

​	解决通信两端处理数据包速度不一致的问题的，比如接收端处理速度慢，让发送端慢点发。

​	通过接收端告诉发送端接收窗口有多大来调整发送窗口的大小。

##### 拥塞控制

​	出现拥塞的条件：对资源需求的综合 > 可用资源。 比如网络带宽50M带宽，所有计算机在网路上传输数据包的量已经大于50M/s  就会出现拥塞。

- 拥塞控制作用

  <img src="E:\Typora\imgs\image-20200702221716996.png" alt="image-20200702221716996" style="zoom:80%;" />

  轻度拥塞的情况下，已经会出现少量丢包的情况；通塞的状态下，随着负载的增加，吞吐量甚至会变成0

  路由器不工作了！

- 实现拥塞控制的机制--- 慢开始和拥塞避免

![image-20200702222855478](E:\Typora\imgs\image-20200702222855478.png) 

- 慢开始的原理与拥塞避免

![image-20200702223322120](E:\Typora\imgs\image-20200702223322120.png)

![image-20200702223342996](E:\Typora\imgs\image-20200702223342996.png)

![image-20200702223352726](E:\Typora\imgs\image-20200702223352726.png)

![image-20200702224050040](E:\Typora\imgs\image-20200702224050040.png)

![image-20200702224224847](E:\Typora\imgs\image-20200702224224847.png)

- 快重传

  接受方收到的数据包只要收到了没有按顺序来的就知道中间丢包了，那么就及时地发三个确认而不必等到累计确认点再发送确认包

  <img src="E:\Typora\imgs\image-20200703082733304.png" alt="image-20200703082733304" style="zoom:50%;" />



此时，连续收三个确认，说明发送发知道网络已经快堵塞了,会执行快重传算法 -- 快恢复和快重传配套使用的

<img src="E:\Typora\imgs\image-20200703082954737.png" alt="image-20200703082954737" style="zoom:67%;" />

- 发送窗口的上限值

  发送方的发送窗口的上限值应当取接受方窗口和拥塞窗口这两个变量中较小的一个：

  ``发送窗口上限值 = Min（rwnd,  cwnd)``;

##### TCP首部格式	

​	<img src="E:\Typora\imgs\image-20200702163702029.png" alt="image-20200702163702029" style="zoom:67%;" />

###### 各字段含义

- URG

  紧急的数据包，可以插队，在发送缓冲区中优先发送

- SYN

  ACK = 1  请求建立会话

- PSH

  A -----> B  B有个接受缓冲，如果数据包PSH = 1 则优先接受这个数据包

- ACK

  ACK  = 1

- 窗口

  16位。 窗口（缓冲区）大小. A, B两个计算机互相通信之前，都会先协商，根据对方的接收窗口大小设置自己的发送窗口大小 

- 校验和

  校验范围是首部 + 数据 两部分。和UDP一样，在校验前要在报文段的前面加上12个字节的伪首部。

- 紧急指针

  只要在URG = 1时才起作用。 比如紧急指针= 50， 就说明数据包的第一个字节到滴50个字节是需要紧急处理的。

- 选项

  ![image-20200702204810235](E:\Typora\imgs\image-20200702204810235.png)

  有最大报文段长度； 是否支持选择性确认

抓包工具的抓包截图：

![image-20200702165840845](E:\Typora\imgs\image-20200702165840845.png)

具体握手的包的截图：

client ------ > web

![image-20200702193830185](E:\Typora\imgs\image-20200702193830185.png)

​	window size： 缓冲区大小

web ----- > client

![image-20200702193942633](E:\Typora\imgs\image-20200702193942633.png)

 

发送过程示意图：

<img src="E:\Typora\imgs\image-20200702192754503.png" alt="image-20200702192754503" style="zoom:80%;" />

##### 传输连接管理

传输连接三个阶段，连接建立，数据传送，连接释放

- 三次握手建立连接 

  <img src="E:\Typora\imgs\image-20200703093347038.png" alt="image-20200703093347038" style="zoom:80%;" />

- TCP的连接释放

  - 数据传输结束后，双方都可以释放连接。现在A的应用进程先向TCP发出释放连接的报文段，并停止再发送数据，主动关闭TCP连接

  - A把释放连接的报文段首部的FIN 位置1,序号seq = u， 等待B的确认

  - B收到确认后， 确认ack = u + 1, 自己的报文段的序号 seq = v， ACK = 1。然后TCP服务器进程通知高层应用进程；从A - -- > B这个方向的连接就释放了， TCP连接处于半关闭状态。B若发送数据，A仍要接受。

  - 当B把数据发送完了，会发送报文段 FIN = 1, ACK = 1, seq = w, ack = u + 1。同时应用进程通知TCP释放连接。

  - A收到释放连接报文后，必须发出确认报文。

    <img src="E:\Typora\imgs\image-20200703135018866.png" alt="image-20200703135018866" style="zoom:80%;" />

MSL 最长报文寿命  默认2min。A收到FIN后，还得等2MSL，处于TIME-WAIT状态：

因为如果B没有收到A发来的ACK,那么B会继续发送FIN，而A如果已经关掉了， 那么就不会再法ACK包，导致B永远无法关掉了。