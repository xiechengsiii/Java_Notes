### KESS

##### KESS是什么

KESS 是快手统一的**服务发现及治理平台**。KESS最初设计旨在提供服务发现的能力，服务发现意味着KESS服务器需要对各服务的各个实例有全局的了解与通信能力。

- 服务发现 

  服务发现做的事就是提供对服务的寻址。即给出服务名，我们需要给出服务对应的实例集合。

##### KESS的目标

​	快速，准确，稳定的收集和下发路由。

- 快速

  服务的路由表可能会经常发生**变化**，例如服务1又上了一个实例，路由表上多了一行，因此我们要将服务1路由表发送至所有需要用到服务1路由表的client。采用了两种方案做到快速：

  1.**轮询**。兜底策略。例如每5s检查远端路由表有没有发生变化，发生变化了就拉取下来。

  2.但是为了达到”快速“的特征，我们希望路由表一旦发生变化，主调方可以得到及时的通知。因此此处Agent和Distributor中间我们采用的是Stream双向流的方式。也就是说，Distributor可以主动的向agent推送路由表。所以Agent和Distributor之间获取信息采用的是**既推又拉**的方式，这满足了我们在”快速“方面的目标。

- 稳定

  1.distributer的**容量冗余**

  2.agent和distributor之间的**心跳检查**：Agent判断当前Distributor无法正常工作（机器挂掉/进程死掉等），Agent会自动切换到下一个可用的distributor上

- 准确

  agent通过**原子操作**将服务路由表写到SHM和DISK去。

​	**fail-ove**r：一般称作失效转移。在这里的含义是指A服务调用B服务，本来B服务有两个实例，请求均匀的分到两个实例。现在假设实例1挂了，kess上暂未将实例1摘除，在A服务多次请求实例1失败后会触发语言框架里预先实现的熔断机制，之后A访问B的请求都打到实例2。