##   																																																											网络层 

主要任务是把**分组**从源端传送到目的端，为分组交换网络上的不同主机提供通信服务。网络层传输单位是**数据报**。

分组是把数据报切割的得到的数据。—  — —  —— — —  —

![image-20200723233814622](E:\Typora\imgs\image-20200723233814622.png)

这里的**拥塞**是全局性的概念，和流量控制完全不一样：	

流量控制是接受方的接受速率和发送方的发送速率不匹配，接受方告诉发送方慢点发；而拥塞是指网络中每个节点都在忙碌的工作，整个网络负载过重

- 数据交换

  ![image-20200724215413830](E:\Typora\imgs\image-20200724215413830.png)

  分组交换的发送时延要小于报文交换的发送时延

  其中分组交换，还分为数据报方式和虚电路方式：

  ![image-20200724215923899](E:\Typora\imgs\image-20200724215923899.png)

  ![image-20200724220254008](E:\Typora\imgs\image-20200724220254008.png)

  如果报文太长，传输层会把报文分割成一段一段；报文很小则不会分割

- 提供的两种服务     虚电路服务    /   数据报服务

  ##### 比较：![image-20200724221028160](E:\Typora\imgs\image-20200724221028160.png)

  现在都是用的**数据报服务**

##### 网络互连的设备

  中间设备又称中间系统或者**中继系统**

  - 物理层中继系统           **转发器**

  - 数据链路层中继系统     **网桥或交换机**

  - 网络层    **路由器 ** 

    注意，路由器的总是有两个或者两个以上的IP地址。并且每个接口的IP地址的网络号是不同的。

    路由器的一个接口相当于一个网卡，有IP地址和MAC地址

  - 网络层以上的    **网关**  （不过我们现在大部分所说的“网关”是指路由器上的接口地址，并不是指原始定义的网络层以上的网关）

    ​	

    ​	我们看网络好不好，首先会 ping 网关，就是路由器那个接口的地址

    <img src="E:\Typora\imgs\image-20200626102840311.png" alt="image-20200626102840311" style="zoom:67%;" />

一般来说，设置网关都是设置本网段的第一个地址或者最后一个地址（1或者254）,防止和计算机的IP地址重复

<font color=#FF0000>主机字段不能全为1和0，全0代表网段，全1代表一个广播信号</font>

##### IP协议简介

- 网际协议IP是TCP/IP体系中两个最主要的协议之一。与IP协议配套使用的还有4个协议：

  - 地址解析协议 ARP
  - 逆地址解析协议 RARP
  - 网际控制报文协议 ICMP
  - 网际组管理协议  IGMP   管理组播的

- 网络层四个协议之间的层次![image-20200626103808189](E:\Typora\imgs\image-20200626103808189.png)

  ARP层次最低，IP协议是要依赖于ARP协议工作的，ICMP, IGMP层次稍高，都是依赖于IP协议工作的。
  
  ​    

### IP层次结构

##### 	网络地址
 ![image-20200626105051268](E:\Typora\imgs\image-20200626105051268.png)

![image-20200626110246240](E:\Typora\imgs\image-20200626110246240.png)

 ![image-20200727223112103](E:\Typora\imgs\image-20200727223112103.png)

- 几个特殊的地址

  ![image-20200727222241079](E:\Typora\imgs\image-20200727222241079.png)

  - 127.0.0.1   本地环回地址

  - 169.254.0.0  windows系统IP地址设置成自动分配后，无法获得自动分配地址时自动产生的临时地址

    ![image-20200627231225051](E:\Typora\imgs\image-20200627231225051.png)

  保留的私网地址

  ​    在互联网上，这些地址没有被服务器使用，可以让企业/学校内的内部人员来是使用

  ![image-20200727222554338](E:\Typora\imgs\image-20200727222554338.png)
  
  ​		分别对应A类， B类，C类地址
##### 子网掩码

​	![image-20200626112638162](E:\Typora\imgs\image-20200626112638162.png)

子网掩码的作用： **将某个IP地址划分成网络地址和主机地址两个部分** , 与运算后主机位会归零 eg:

```java
计算机A：
    IP:192.168.80.123
    子网掩码：255.255.255.0
    网关：192.168.80.1
        
计算机B：
    IP：192.168.90.128
 如果A想和B通信， A将自己的IP & 子网掩码 判断出网段 = 192.168.80
        		然后拿B的IP & 子网掩码   得到网段 = 192.168.90
        		不在同一个网段，那么就会将数据报发送给路由网关，进行转发;
如果A的子网掩码是255.255.0.0,那么拿掩码分别于A的IP ，B的IP进行与运算可以得到A,B在同一个网段192.168,
那么发送数据的时候就不会经过网关而直接发送
```

##### 子网划分

- 分类的IP地址的缺点

  1.IP地址空间的利用率有时很低

  2.两级IP地址不够灵活

​	目的是为了充分利用ip地址，解决IP地址数量不够的问题

![image-20200727224423073](E:\Typora\imgs\image-20200727224423073.png)

主机号全0是网段号，全1是广播

![image-20200727224631453](E:\Typora\imgs\image-20200727224631453.png)

![image-20200727225103309](E:\Typora\imgs\image-20200727225103309.png)

主机号对应的子网掩码为0，其余都是1

![image-20200727225427576](E:\Typora\imgs\image-20200727225427576.png)

![image-20200727225855770](E:\Typora\imgs\image-20200727225855770.png)



![image-20200727232953168](E:\Typora\imgs\image-20200727232953168.png)



![image-20200626114957534](E:\Typora\imgs\image-20200626114957534.png)







现在网关可不是255.255.255.0了，而是255.255.255.128,相当于在将原先的网段等分了两 个子网

分成 四个子网：![image-20200626135526358](E:\Typora\imgs\image-20200626135526358.png)

子网划分不是随便划分的：每次都是对半划分

有子网的拆分，还有子网的合并--超网

##### 无分类编址 CIDR

![image-20200727231623595](E:\Typora\imgs\image-20200727231623595.png)

![image-20200727232027610](E:\Typora\imgs\image-20200727232027610.png)



##### 超网

​	将多个子网聚合成一个较大的子网，叫构成超网或者路由聚合，这是为了减少路由器的表项。

可以看成和划分子网相逆的过程

![image-20200727232635701](E:\Typora\imgs\image-20200727232635701.png)

![image-20200727233437802](E:\Typora\imgs\image-20200727233437802.png)

​	所以应该选B

![image-20200727235031653](E:\Typora\imgs\image-20200727235031653.png)

​	这里是指在CIDR的基础上，再在主机位上取高位划分子网，也就是在``192.168.5.0/24``的后8位上划分子网。

##### IP地址与MAC地址

​	有了MAC地址为什么还要IP地址呢？

​	IP地址决定了数据包的起点和终点，MAC地址决定了数据帧的下一跳由哪个设备接收

![image-20200626185004487](E:\Typora\imgs\image-20200626185004487.png)

##### ARP协议

<img src="E:\Typora\imgs\image-20200626191902660.png" alt="image-20200626191902660" style="zoom:67%;" />

- ARP简介

  不管网络层使用什么协议，在实际网络的链路上传输数据帧时，最终还是需要用到物理地址。

  每个主机/路由器都有一个APR高速缓存，里面有所有局域网上各主机和路由器的IP到硬件地址的映射表。

  当主机A向B发送IP数据报时，就先在主机A的**ARP Cache**查看有无B的IP地址，如果有，就可查出其MAC地址，然后写入MAC帧，然后通过局域网将该帧发送至该硬件地址。

  我有个问题：是如何查到中间设备的mac地址呢?

  我觉得：如果不在同一个网段，首先向网关发送广播ARP请求分组，如下图右下角所示，然后网关返回单播ARP相应分组；

  ![image-20200728194803718](E:\Typora\imgs\image-20200728194803718.png)

  ![](E:\Typora\imgs\image-20200728200339387.png) 

  比如，主机发送IP数据报给主机B，经过了5个路由器，在本地ARP高速缓存没有表项的时候，这个过程需要使用6次ARP协议

- ARP欺骗	 

  原理就是告诉你一个错误的MAC地址或者第三方机器的MAC地址，然后你发送的数据包就会发送至第三方机器而造成泄密。

##### DHCP协议   动态主机配置协议

​	![image-20200728202453142](E:\Typora\imgs\image-20200728202453142.png)

![image-20200728202938785](E:\Typora\imgs\image-20200728202938785.png)



##### IP数据报（数据包）

- 一个IP数据包由首部和数据两部分组成

  - 首部的前一部分是固定长度，20个字节，所有IP数据包必须有的
  - 首部的固定部分的后面是一些可选字段，长度可变

  <img src="E:\Typora\imgs\image-20200626192742610.png" alt="image-20200626192742610" style="zoom:67%;" />

![image-20200626192818647](E:\Typora\imgs\image-20200626192818647.png)

固定部分占20字节

- 版本   IPV4?IPV6?

- 首部长度    

  占4位。可以表示的最大数值是15个单位（一个单位 = 4字节），因此IP数据包的首部长度最大为60字节

- 区分服务 

  在数据包上打一个标记。说明这个数据包是着急？不着急？期望获得的服务类型

- 总长度  

  16位。指首部和数据之和的长度。因此数据包的最大长度为65535字节。总长度不能超过最大传输单元MTU（1500字节）。单位为1字节

- 标识 

  一个计数器。用来产生数据报的标识，不是序号，每产生一个数据包，就增加1

  同一个数据报的所有分片使用同一标识

- 标志   

  <img src="E:\Typora\imgs\image-20200727202712173.png" alt="image-20200727202712173" style="zoom:80%;" />

  

  整包还是分片后的包？ 为啥要分片？比如你数据包大3800字节，超过MTU，所以需要分片。因此有个标记位来标记

- 片偏移

  分组在分片后某片在原分组中的相对位置。片偏移以8个字节为偏移单位

  因此，除了最后一个分片，每一个分片的长度以定势8字节的整数倍

  ![image-20200727203416129](E:\Typora\imgs\image-20200727203416129.png)

- 生存时间  TTL

  数据包在网络中可以通过的路由器数的最大值   经过一个路由器-1，变成0则丢弃

  为了防止数据报在网络中"兜圈子"而成资源的浪费

- 协议

  数据包携带的数据使用何种协议，以便目的主机将数据部分上交给哪个处理进程

  <img src="E:\Typora\imgs\image-20200626194934308.png" alt="image-20200626194934308" style="zoom:67%;" />

  ![image-20200727201801870](E:\Typora\imgs\image-20200727201801870.png)

- 校验和  只校验首部不校验数据部分

- 可变部分

  ![image-20200626195330425](E:\Typora\imgs\image-20200626195330425.png)

- 填充  全0，把首部补成4B的整数倍

关于**MTU**  最大传送单元

​	链路层数据帧可封装数据的上限   

​	以太网的MTU = 1500B     数据帧的数据部分最大1500B，也就是IP分组最大1500B

![image-20200727202407585](E:\Typora\imgs\image-20200727202407585.png)

​	

- IP数据报的三种传输方式

![image-20200729195913627](E:\Typora\imgs\image-20200729195913627.png)

![image-20200729195955624](E:\Typora\imgs\image-20200729195955624.png)

![image-20200729200128739](E:\Typora\imgs\image-20200729200128739.png)

源主机如何找到组播组的主机呢？

![image-20200729201107318](E:\Typora\imgs\image-20200729201107318.png)

![image-20200729202019451](E:\Typora\imgs\image-20200729202019451.png)

 ![image-20200729202303629](E:\Typora\imgs\image-20200729202303629.png)

![image-20200729202523992](E:\Typora\imgs\image-20200729202523992.png)

![image-20200729202636340](E:\Typora\imgs\image-20200729202636340.png)



####  路由

​	路由器在不同网段换发数据包

- 典型的路由结构：<img src="E:\Typora\imgs\image-20200627220820654.png" alt="image-20200627220820654" style="zoom: 67%;" />

​	网络畅通：数据包必须来回都没有问题。

![image-20200626201836808](E:\Typora\imgs\image-20200626201836808.png)

##### 路由算法

![image-20200724222628383](E:\Typora\imgs\image-20200724222628383.png)

![image-20200724222854234](E:\Typora\imgs\image-20200724222854234.png)

比如：![image-20200724223044191](E:\Typora\imgs\image-20200724223044191.png)

###### RIP协议

![image-20200724233247258](E:\Typora\imgs\image-20200724233247258.png)

![image-20200724231330066](E:\Typora\imgs\image-20200724231330066.png)		RIP报文就包含了路由表的所有信息

- 练习

  ![image-20200724231927046](E:\Typora\imgs\image-20200724231927046.png)

![image-20200724232401222](E:\Typora\imgs\image-20200724232401222.png)

![image-20200724232757173](E:\Typora\imgs\image-20200724232757173.png)

![image-20200724232821848](E:\Typora\imgs\image-20200724232821848.png)

​		“坏消息”传的慢，也就是**慢收敛**

![image-20200724232932030](E:\Typora\imgs\image-20200724232932030.png)

注意，RIP协议是运行在UDP上的应用层的协议   rip的距离向量实际上就是指的跳数

###### OSPF协议	

​	属于网络层协议

###### ![image-20200724233650328](E:\Typora\imgs\image-20200724233650328.png)

![image-20200724234057185](E:\Typora\imgs\image-20200724234057185.png)

AS还可以划分为更小的区域，可以减少路由器之间交换的信息量

![image-20200724234428448](E:\Typora\imgs\image-20200724234428448.png)

![image-20200724234729300](E:\Typora\imgs\image-20200724234729300.png)

###### BGP协议

![image-20200724235028632](E:\Typora\imgs\image-20200724235028632.png)

BGP所交换的网络可达性的信息就是要到达某个网络所要经过的一些列AS。当BGP发言人互相交换了网络可达性的信息后，各发言人就根据所采用的策略从收到的路由信息找出到达各AS的较好路由

###### 三种路由协议比较

![image-20200725000007486](E:\Typora\imgs\image-20200725000007486.png)

##### 网络负载均衡

##### ICMP 

​	为了提高IP数据包交付成功的机会，在网络层使用网际控制报文协议

​	![image-20200728203123894](E:\Typora\imgs\image-20200728203123894.png)

​	这里的检验和和IP数据报的检验和不冲突的，因为IP数据报的检验和只检验首部的正确性，不检验数据部分；

- ICMP允许主机或路由器报告差错情况和提供有关异常的报告
- ICMP报文作为IP数据包的数据，加上数据包的首部，组成IP数据包发送出去


###### 类型

![image-20200728203559830](E:\Typora\imgs\image-20200728203559830.png)

![image-20200728203816531](E:\Typora\imgs\image-20200728203816531.png)

![image-20200728205755599](E:\Typora\imgs\image-20200728205755599.png)

​	组播区别与广播，是有选择性的，广播是一点到局域网所有节点，组播是到部分节点

![image-20200728205958432](E:\Typora\imgs\image-20200728205958432.png)

![image-20200728210217770](E:\Typora\imgs\image-20200728210217770.png)

##### ``pathping``是一个很有用的命令：

![image-20200626211932631](E:\Typora\imgs\image-20200626211932631.png)

##### 动态路由协议

下面几个协议都是动态路由协议

- RIP  

  周期性广播（30s） 。选择最佳路径的依据是经过的跳数最少

- OSPF协议   内部网关协议  同一个自治系统内部都使用相同的路由协议

  选择最佳路径的依据是带宽

  触发式更新  ： 三个表

  - 邻居表  发hello包
  - 链路状态表
  - 计算路由表

- BGP  外部网关协议

  ![image-20200627220122706](E:\Typora\imgs\image-20200627220122706.png)

<img src="E:\Typora\imgs\image-20200627220231315.png" alt="image-20200627220231315" style="zoom: 67%;" />

相当于AS之间的路由：![image-20200627220346171](E:\Typora\imgs\image-20200627220346171.png)

BGP所交换的网络可达性的信息就是要到达某一个网络所要经过的一系列AS.

当BGP发言人互相交换了网络可达性的信息之后，各BGP发言人根据所采用的策略从收到的路由信息中找到到达各自AS的较好路由。

##### 网络地址转换技术  NAT  PAT   

![image-20200727223315077](E:\Typora\imgs\image-20200727223315077.png)

网络地址转换NAT：在专用网连接到因特网的路由器上安装NAT软件，安装了NAT软件的路由器叫做NAT路由器，它至少有一个外部全球IP地址，实现了私有地址（上图中A,B,C三类中的某些特殊地址）到公网地址的转换

![image-20200727223939100](E:\Typora\imgs\image-20200727223939100.png)	

​	能够实现一堆的计算使用同一个IP地址访问internet。出去的时候数据包的流量都是由这个公网IP地址收发的。

通过这个技术，IPV4才能用到今天，不然IPv4的地址早就用完了。我们私网的计算机能访问公网，公网的计算机进不来。NAT严格意义上不节省IP地址：比如路由器上有十个公网IP地址，只能允许10台计算机能上网，当连11台时，没有地址可以更换了就无法访问公网了。真正节省公网地址的是PAT协议，可以把计算机的端口替换，这样就可以一个地址多个机器共同上网。

​	所以NAT和PAT的区别: NAT替换IP地址，PAT替换端口

​	做了地址转换之后，要让互联网上的计算机访问内网，还需要做**端口映射**。比如一个私网内A,B,C,D的计算机使用同样的端口x, 那么外网计算机访问这些私网内的机器需要连那个公网地址  + 端口号，比如10.7.86.4:4000, 映射私网内的A:x,  10.7.86.4:4001映射成B ：x， 10.7.86.4:4002 映射成C:x,这样就可以通过访问公网IP ： 不同的端口号  ,通过端口映射连接到私网内的不同计算机。 

<img src="E:\Typora\imgs\image-20200627231749342.png" alt="image-20200627231749342" style="zoom:80%;" />



##### IPv6

​	![image-20200728210403099](E:\Typora\imgs\image-20200728210403099.png)

``数据报格式``

![image-20200728210635265](E:\Typora\imgs\image-20200728210635265.png)

![image-20200728212823452](E:\Typora\imgs\image-20200728212823452.png)

差别：![image-20200728213204678](E:\Typora\imgs\image-20200728213204678.png)

``ipv6地址的表示``

![image-20200728213356539](E:\Typora\imgs\image-20200728213356539.png)

``IPv4 <---->IPv6``

![image-20200728213751774](E:\Typora\imgs\image-20200728213751774.png)





##### 移动IP

![image-20200729204515416](E:\Typora\imgs\image-20200729204515416.png)

![image-20200729204704929](E:\Typora\imgs\image-20200729204704929.png)

##### VPN    

​	可以实现远程网络通过VPN服务器连到内网

![image-20200627224815809](E:\Typora\imgs\image-20200627224815809.png)

这就相当于在公网上传私有数据/进行私密通信

<img src="E:\Typora\imgs\image-20200627231529964.png" alt="image-20200627231529964" style="zoom: 67%;" />

​											配置好两端的VPN服务器即可

你是公网IP，如果通过VPN后再访问其他服务器，是先走VPN服务器，然后再走到目的服务器。在目的服务器看来，数据的来源是VPN服务器的IP。 VPN翻墙原理就是类似的。 

##### 网络层设备

​	![image-20200729205140754](E:\Typora\imgs\image-20200729205140754.png)

​	转发表：是在路由器内部，输入端口的分组应该转发给发给哪个输出端口；而路由表是宏观的：下一跳走哪个路由器。![image-20200729210523673](E:\Typora\imgs\image-20200729210523673.png)



![image-20200729205827450](E:\Typora\imgs\image-20200729205827450.png)

![image-20200729210034577](E:\Typora\imgs\image-20200729210034577.png)

![image-20200729210336466](E:\Typora\imgs\image-20200729210336466.png)



## 传输层

传输层为相互通信的应用进程提供了逻辑通信

网络层是地址（主机）到地址（主机）， 传输层是进程到进程

![image-20200701103758538](E:\Typora\imgs\image-20200701103758538.png)

![image-20200730222813827](E:\Typora\imgs\image-20200730222813827.png)

​	 通过 TCP/UDP + 端口号 找到对应的应用程序

​	网络中采用发送方和接受方的套接字组合来识别端点，套接字唯一标识了网络中的一个主机和它上面的一个进程。套接字**sockect** =  主机IP地址 + 端口号

协议栈：

![image-20200630085604414](E:\Typora\imgs\image-20200630085604414.png)

- TCP

  应用场景：需要将传输的文件分段，  传输需要建立会话，  可靠传输 流量控制

- UDP

  应用场景：一个数据包就能够完成数据通信就可以用UDP， 不分段， 不需要建立会话，不进行流量控制  不可靠传输  还用于多播 ， 广播
---

传输层协议和应用层之间的关系

  常见的应用层协议使用的的端口：

  http = tcp + 80            https  = tcp + 443     ftp = tcp + 21          smtp  =  tcp + 25

DNS  = udp + 53   	sql = tcp + 1433

服务使用TCP或者UDP的端口侦听客户端的请求，客户端使用IP地址定位服务器，使用目标端口定位服务

可以在服务器网卡上设置只开放必要的端口实现服务器网络安全

测试远程某个计算机是否打开： telnet 192.168.80.100 3389

端口就是对应着服务。可以通过改端口号来增加网络完全。比如你攻击21端口的FTP服务，但是这个端口根本就不是FTP服务。

- 所以让服务器更加安全呢？

  网卡上只设置必要的端口，比如你是web服务器，只提供web服务，那么你网卡上只需要开80端口，那么其他人只能访问你的web服务。

---

#### UDP

![image-20200730231118033](E:\Typora\imgs\image-20200730231118033.png)

- 无连接

- 尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制

- 面向报文。没有拥塞控制，很适合多媒体通信的要求

  面向报文就是指，应用层传递给UDP多长的报文，UDP就照样发送，不会进行分片，一次发一个完整报文

- 支持一对一，一对多，多对1，多对多的交互通信

- 首部开销小，只有8个字节。

##### 首部格式

​	 ![image-20200730231443953](E:\Typora\imgs\image-20200730231443953.png)

![image-20200730231656150](E:\Typora\imgs\image-20200730231656150.png)

这里的伪首部伪的是IP数据报的首部

![image-20200730232432480](E:\Typora\imgs\image-20200730232432480.png)

#### TCP

- 面向连接  是虚连接，不是实际上的物理连接 ， 好像是进程和进程之间直接连在了一起一样

- 每一条TCP连接只能有两个端点（endpoint），每一条tcp连接只能是点对点的  所以没法应用于广播/多播

- 提供可靠交付的服务  可靠有序，不丢不重

- 提供全双工通信

  ​	发送方接受方两端都有缓存：

  - 发送缓存    有准备发送的数据 &&  已发送但尚未收到确认的数据
  - 接受缓存    按序到达但尚未被应用程序读取的数据 &&  没有按序到达的数据

- 面向字节流    TCP把应用程序交下来的数据仅仅是看成一串无结构的字节流

##### 端口

​	用一个16位标记（0 -- 65535），只具有本地意义，是为了标记本计算机的各应用进程。本地计算机的端口号不能重。	

- 熟知端口（一般0-1023）

  ftp 21  http 80   telnet 23   smtp 25    dns 53   https 443   rdp 3389

- 登记端口   1024-49151

- 客户端端口  49152-65535

TCP连接端点不是主机，不是主机的IP地址，不是应用进程，而是套接字。端口号拼接到IP地址即构成了套接字

传输之前，会将要传输的数据放到缓冲区，对应接受方也有缓冲区，接受的数据先进入缓冲区

##### TCP首部格式	

![image-20200731002643463](E:\Typora\imgs\image-20200731002643463.png)

6个控制位

![image-20200731003106821](E:\Typora\imgs\image-20200731003106821.png)

- 窗口

  16位。指的是接受窗口的大小，告诉对方自己地接受窗口的大小 

  窗口（缓冲区）大小. A, B两个计算机互相通信之前，都会先协商，根据对方的接收窗口大小设置自己的发送窗口大小 

- 校验和

  校验范围是首部 + 数据 两部分。和UDP一样，在校验前要在报文段的前面加上12个字节的伪首部（类似于IP首部，和UDP的伪首部一样，不过第四个字段为6）。

- 紧急指针

  只要在URG = 1时才起作用。 比如紧急指针= 50， 就说明报文段的第一个字节到第 50个字节是需要紧急处理的。

- 选项

  MSS：每个报文段中数据字段的最大长度

  还有选择确认，窗口扩大，时间戳....

  ![image-20200702204810235](E:\Typora\imgs\image-20200702204810235.png)

  有最大报文段长度； 是否支持选择性确认

抓包工具的抓包截图：

![image-20200702165840845](E:\Typora\imgs\image-20200702165840845.png)

具体握手的包的截图：

client ------ > web

![image-20200702193830185](E:\Typora\imgs\image-20200702193830185.png)

​	window size： 缓冲区大小

web ----- > client

![image-20200702193942633](E:\Typora\imgs\image-20200702193942633.png)

 

发送过程示意图：

<img src="E:\Typora\imgs\image-20200702192754503.png" alt="image-20200702192754503" style="zoom:80%;" />

##### TCP连接管理

传输连接三个阶段，连接建立，数据传送，连接释放

- 三次握手建立连接 

![image-20200804153921538](E:\Typora\imgs\image-20200804153921538.png)

​	注意，**只有连接请求和连接请求接受的报文 SYN位 = 1，** 其余报文``SYN`` = 0

​	**SYN洪泛攻击**![image-20200804154138809](E:\Typora\imgs\image-20200804154138809.png)

​	解决的方法是SYN cookie

- TCP的连接释放

  - 数据传输结束后，双方都可以释放连接。现在A的应用进程先向TCP发出释放连接的报文段，并停止再发送数据，主动关闭TCP连接

  - A把释放连接的报文段首部的FIN 位置1,序号seq = u， 等待B的确认

  - B收到确认后， 确认ack = u + 1, 自己的报文段的序号 seq = v， ACK = 1。然后TCP服务器进程通知高层应用进程；从A - -- > B这个方向的连接就释放了， TCP连接处于半关闭状态。B若发送数据，A仍要接受。

  - 当B把数据发送完了，会发送报文段 FIN = 1, ACK = 1, seq = w, ack = u + 1。同时应用进程通知TCP释放连接。

  - A收到释放连接报文后，必须发出确认报文。

    ![image-20200804162115463](E:\Typora\imgs\image-20200804162115463.png)

MSL 最长报文寿命  默认2min。A收到FIN后，还得等2MSL，处于TIME-WAIT状态：

因为如果B没有收到A发来的ACK,那么B会重传FIN报文段，而A如果已经关掉了， 那么就不会再法ACK包，导致B永远无法关掉了。 

##### 如何实现可靠传输

可靠：保证接受方进程从缓存区读出的字节流与发送方发送的字节流是完全一样的

**实现可靠的机制**

1.校验

与UDP校验一样，增加伪首部

2.序号

3.确认

4.重传

![image-20200804165825478](E:\Typora\imgs\image-20200804165825478.png)

​	连续收到3个冗余的重复ACK，那么就不需要等到计时器结束直接重传2号报文段

这里结合前面链路层的SR， GBN协议看，TCP的流量控制和滑动窗口和之前链路层讲解的大同小异。 

<img src="E:\Typora\imgs\image-20200702154949935.png" alt="image-20200702154949935" style="zoom: 50%;" />

<img src="E:\Typora\imgs\image-20200702155133524.png" alt="image-20200702155133524" style="zoom:67%;" />

<img src="E:\Typora\imgs\image-20200702154011742.png" alt="image-20200702154011742" style="zoom: 50%;" />

停止等待协议的优点是简单，但是信道利用率太低。<img src="E:\Typora\imgs\image-20200702155606724.png" alt="image-20200702155606724" style="zoom:80%;" />

发送数据包时间TD , 接受时间TA，发送时间占总时间太短了， 大部分时间都浪费了RTT上。

$$	信道利用率 U  = Td/(Td  + RTT + Ta)$$		

可以是发送方连续发送多个分组，不必没发完一个数据包就停顿下来等待对方的确认。由于信道上一直有数据不间断地传输，这种运输方式可以获得很高的信道利用率。

<img src="E:\Typora\imgs\image-20200702160159225.png" alt="image-20200702160159225" style="zoom:67%;" />

通过滑动窗口来实现流水线传输：<img src="E:\Typora\imgs\image-20200702162915104.png" alt="image-20200702162915104" style="zoom:50%;" />



收到了1的确认之后，窗口往右移动 - --  每收到窗口第一个序号对应的确认后，窗口就往右移动

还有**累积确认**

###### 实现可靠传输详解

- 以字节为单位的滑动窗口

   阶段1

<img src="E:\Typora\imgs\image-20200702205317673.png" alt="image-20200702205317673" style="zoom: 50%;" />

​		阶段2

<img src="E:\Typora\imgs\image-20200702210342090.png" alt="image-20200702210342090" style="zoom:50%;" />

​					B发送ack = 7， B的接收窗口也会往右移动6个字节；A接受到ack = 7， 往右移动6个字节

- 超时重传时间的选择

  <img src="E:\Typora\imgs\image-20200702211543675.png" alt="image-20200702211543675" style="zoom:80%;" />

##### 如何实现流量控制

​	解决通信两端处理数据包速度不一致的问题的，比如接收端处理速度慢，让发送端慢点发。

​	通过接收端告诉发送端接收窗口有多大来调整发送窗口的大小。

![image-20200805151752178](E:\Typora\imgs\image-20200805151752178.png)



![image-20200805153411594](E:\Typora\imgs\image-20200805153411594.png)

- 为什么要有这样一个计时器呢？

  如果没有，当接受方B发送为0的窗口通知后，想要发送方A继续发送数据，需要再发送一个报文段，里面包含一个非0的窗口通知， 比如``rwnd=400``,如果这个报文段丢失，就会造成：主机A发送窗口为0， 在等待B的通知；主机B也在等A发来数据；类似于形成了死锁的局面。因此，需要为每一个连接设置一个定时器，一旦接受方收到对方的零窗口通知，就启动持续计时器：时间一到期，就发送一个零窗口探测报文段（只携1B的数据）。

##### 拥塞控制

​	出现拥塞的条件：对资源需求的总和 > 可用资源。 比如网络带宽50M带宽，所有计算机在网路上传输数据包的量已经大于50M/s  就会出现拥塞。

![image-20200805154419161](E:\Typora\imgs\image-20200805154419161.png)

​	流量控制是点对点的问题，

- 拥塞控制作用

  <img src="E:\Typora\imgs\image-20200702221716996.png" alt="image-20200702221716996" style="zoom:80%;" />

  轻度拥塞的情况下，已经会出现少量丢包的情况；通塞的状态下，随着负载的增加，吞吐量甚至会变成0

  路由器不工作了！

- 拥塞控制的算法

  ![image-20200805154645202](E:\Typora\imgs\image-20200805154645202.png)

- 慢开始和拥塞避免

![image-20200702222855478](E:\Typora\imgs\image-20200702222855478.png) 

- 慢开始的原理与拥塞避免

![image-20200702223322120](E:\Typora\imgs\image-20200702223322120.png)

![image-20200702223342996](E:\Typora\imgs\image-20200702223342996.png)

![image-20200702223352726](E:\Typora\imgs\image-20200702223352726.png)

![image-20200805155817564](E:\Typora\imgs\image-20200805155817564.png)

什么时候cwnd翻倍？收到接收端发来的确认的时候，即可将cwnd翻倍；

新的``ssthresh``为出现网络拥塞是cwnd窗口的一半

![image-20200702224224847](E:\Typora\imgs\image-20200702224224847.png)

- 快重传和快恢复

  接受方收到的数据包只要收到了没有按顺序来的就知道中间丢包了，那么就及时地发三个确认而不必等到累计确认点再发送确认包

  <img src="E:\Typora\imgs\image-20200703082733304.png" alt="image-20200703082733304" style="zoom:50%;" />



此时，连续收三个确认，说明发送发知道网络已经快堵塞了,会执行快重传算法 -- 快恢复和快重传配套使用的

![image-20200805162542991](E:\Typora\imgs\image-20200805162542991.png)

- 发送窗口的上限值

  发送方的发送窗口的上限值应当取接受方窗口和拥塞窗口这两个变量中较小的一个：

  ``发送窗口上限值 = Min（rwnd,  cwnd)``;

##### 总结

- TCP的可靠传输
  - 检验
  - 序号
  - 确认
  - 重传
    - 超时重传
    - 冗余确认

- TCP的流量控制 

  在确认报文中设置接收窗口的值来限制发送方的发送速度

- TCP的拥塞避免

  - 慢开始&&拥塞避免
  - 快开始&&快恢复