## 文件管理

一些基本概念

![image-20200818230906613](E:\Typora\imgs\image-20200818230906613.png)

![image-20200818232544234](E:\Typora\imgs\image-20200818232544234.png)

![image-20200818232622620](E:\Typora\imgs\image-20200818232622620.png)

![image-20200818232855366](E:\Typora\imgs\image-20200818232855366.png)

![image-20200818233024814](E:\Typora\imgs\image-20200818233024814.png)

#### 文件逻辑结构

​	逻辑结构，就是指在用户看来，文件内部的数据应该是如何组织起来的；而物理结构，指在OS看来，文件的数据是如何存放在外存的

##### 无结构文件

![image-20200818233902677](E:\Typora\imgs\image-20200818233902677.png)

##### 有结构文件

![image-20200818234219827](E:\Typora\imgs\image-20200818234219827.png)

###### 顺序文件

![image-20200818234353144](E:\Typora\imgs\image-20200818234353144.png)

![image-20200818234737066](E:\Typora\imgs\image-20200818234737066.png)

![image-20200818234755579](E:\Typora\imgs\image-20200818234755579.png)

###### 索引文件

![image-20200818235402563](E:\Typora\imgs\image-20200818235402563.png)

###### 索引顺序文件

​	![image-20200818235557930](E:\Typora\imgs\image-20200818235557930.png)

![image-20200818235726065](E:\Typora\imgs\image-20200818235726065.png)

![image-20200818235836121](E:\Typora\imgs\image-20200818235836121.png)

#### 文件目录

![image-20200819000246788](E:\Typora\imgs\image-20200819000246788.png)

文件夹就是目录，目录有对应的目录文件

- 文件控制块

  ![image-20200819000455014](E:\Typora\imgs\image-20200819000455014.png)

![image-20200819000625738](E:\Typora\imgs\image-20200819000625738.png)

![image-20200819000734475](E:\Typora\imgs\image-20200819000734475.png)

- 目录结构

  **单级目录结构**

![image-20200819000959810](E:\Typora\imgs\image-20200819000959810.png)

 	 **两级目录结构**

![image-20200819084701078](E:\Typora\imgs\image-20200819084701078.png)

​	**多级目录结构**

![image-20200819085008981](E:\Typora\imgs\image-20200819085008981.png)

​	引入“当前目录”和“相对路径”后，可以减少磁盘的IO次数，提升文件的访问效率

​	“当前目录”意味着目录表已经调入内存，用户想找当前目录下的某个文件时候，可以从当前目录出发直接往下找，而不是从内存中先找到目录表。

​	![image-20200819085410359](E:\Typora\imgs\image-20200819085410359.png)

 **无环图目录结构**

![image-20200819090540844](E:\Typora\imgs\image-20200819090540844.png)

**对FCB的改进---索引节点**

![image-20200819091203482](E:\Typora\imgs\image-20200819091203482.png)

当找到文件名对应的目录项后，才需要将索引节点调入内存，索引节点中记录了文件的各种信息，包括文件在外存中的存放位置，根据存放位置即可找到对应的文件。

存放在外存的索引节点称为**磁盘索引节点**，当索引节点放入内存，称为**内存索引节点**。相比之下，内存索引节点需要增加几个额外信息，比如文件是否修改过，有几个进程正在访问该文件等。

![image-20200819091640883](E:\Typora\imgs\image-20200819091640883.png)

#### 文件的物理结构（文件分配方式）

![image-20200819091904299](E:\Typora\imgs\image-20200819091904299.png)

##### ![image-20200819092123683](E:\Typora\imgs\image-20200819092123683.png)

几个补充知识

​	**磁盘块，文件块**

![image-20200819092622313](E:\Typora\imgs\image-20200819092622313.png)

![image-20200819092842620](E:\Typora\imgs\image-20200819092842620.png)

##### 文件分配方式

​	这里是对非空闲磁盘块的管理

​	**连续分配**

![image-20200819093116252](E:\Typora\imgs\image-20200819093116252.png)

![image-20200819093246563](E:\Typora\imgs\image-20200819093246563.png)

![image-20200819093328919](E:\Typora\imgs\image-20200819093328919.png)

![image-20200819093433054](E:\Typora\imgs\image-20200819093433054.png)

总结：

连续分配方式需要每个文件在磁盘上占有一组连续的块

优点：支持顺序访问和随机访问；连续分配的文件在顺序访问是速度最快（磁头寻址时间最短）

缺点：不方便文件扩展；存储空间利用率低，会产生磁盘碎片，类似于内存中的外部碎片。

**链接分配**

​	隐式链接

![image-20200819094440412](E:\Typora\imgs\image-20200819094440412.png) 

![image-20200819094712728](E:\Typora\imgs\image-20200819094712728.png)



​	显示链接

![image-20200819095255937](E:\Typora\imgs\image-20200819095255937.png)

![image-20200819095548882](E:\Typora\imgs\image-20200819095548882.png)

![image-20200819095608095](E:\Typora\imgs\image-20200819095608095.png)

**索引分配**

![image-20200819100238326](E:\Typora\imgs\image-20200819100238326.png)	如何实现逻辑块号到物理块号的转换呢？

从目录项中找到索引的存放位置 ---- >  索引表读入内存 ---->  查找索引表即可得到i号逻辑块在外存中的位置

所以，索引分配是<font color = red>支持随机访问的，文件拓展也容易实现</font>（只需分配一个新的空闲块，然后增加一个索引表项即可），但是<font color = red>索引表需要占有一定的存储空间</font>

![image-20200819100851249](E:\Typora\imgs\image-20200819100851249.png)

![image-20200819101505291](E:\Typora\imgs\image-20200819101505291.png)

![image-20200819101858571](E:\Typora\imgs\image-20200819101858571.png)

![image-20200819102252600](E:\Typora\imgs\image-20200819102252600.png)

![image-20200819102609823](E:\Typora\imgs\image-20200819102609823.png)

![image-20200819102621176](E:\Typora\imgs\image-20200819102621176.png)

##### 文件存储空间管理

​	是对空闲磁盘块的管理

![image-20200819102741194](E:\Typora\imgs\image-20200819102741194.png)

**存储空间的划分与初始化**

![image-20200819102922499](E:\Typora\imgs\image-20200819102922499.png)

**存储空间管理**

​	空闲表法

![image-20200819104002915](E:\Typora\imgs\image-20200819104002915.png)

空闲链表法， 又分为空闲盘块链和空闲盘区链

![image-20200819104112438](E:\Typora\imgs\image-20200819104112438.png)

​			空闲盘块链

![image-20200819104210551](E:\Typora\imgs\image-20200819104210551.png)

​	空闲盘区链

![image-20200819104453013](E:\Typora\imgs\image-20200819104453013.png)

位示图法

![image-20200819104746343](E:\Typora\imgs\image-20200819104746343.png)

![image-20200819104901731](E:\Typora\imgs\image-20200819104901731.png)

成组链接法 

![image-20200819105001944](E:\Typora\imgs\image-20200819105001944.png)

![image-20200819105304292](E:\Typora\imgs\image-20200819105304292.png)

注意，分组的第一个磁盘快，需要记录下一组空闲磁盘块的相关信息:下一组空闲盘块数和对应的空闲块号

![image-20200819105918487](E:\Typora\imgs\image-20200819105918487.png)

超级块就相当于一个链头的作用，保存了指向下一个分组的信息

回收：第一个分组满了和没满两种情况

![image-20200819110129139](E:\Typora\imgs\image-20200819110129139.png)

 

![image-20200819110145535](E:\Typora\imgs\image-20200819110145535.png)

比如回收的是201， 只需要在 分组末尾更新201，并增加指向块号为201的链接即可

#### 文件基本操作

![image-20200819140203051](E:\Typora\imgs\image-20200819140203051.png)