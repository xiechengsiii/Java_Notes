## 文件管理

一些基本概念

![image-20200818230906613](E:\Typora\imgs\image-20200818230906613.png)

![image-20200818232544234](E:\Typora\imgs\image-20200818232544234.png)

![image-20200818232622620](E:\Typora\imgs\image-20200818232622620.png)

![image-20200818232855366](E:\Typora\imgs\image-20200818232855366.png)

![image-20200818233024814](E:\Typora\imgs\image-20200818233024814.png)

#### 文件逻辑结构

​	逻辑结构，就是指在用户看来，文件内部的数据应该是如何组织起来的；而物理结构，指在OS看来，文件的数据是如何存放在外存的

##### 无结构文件

![image-20200818233902677](E:\Typora\imgs\image-20200818233902677.png)

##### 有结构文件

![image-20200818234219827](E:\Typora\imgs\image-20200818234219827.png)

###### 顺序文件

![image-20200818234353144](E:\Typora\imgs\image-20200818234353144.png)

![image-20200818234737066](E:\Typora\imgs\image-20200818234737066.png)

![image-20200818234755579](E:\Typora\imgs\image-20200818234755579.png)

###### 索引文件

![image-20200818235402563](E:\Typora\imgs\image-20200818235402563.png)

###### 索引顺序文件

​	![image-20200818235557930](E:\Typora\imgs\image-20200818235557930.png)

![image-20200818235726065](E:\Typora\imgs\image-20200818235726065.png)

![image-20200818235836121](E:\Typora\imgs\image-20200818235836121.png)

#### 文件目录

![image-20200819000246788](E:\Typora\imgs\image-20200819000246788.png)

文件夹就是目录，目录有对应的目录文件

- 文件控制块

  ![image-20200819000455014](E:\Typora\imgs\image-20200819000455014.png)

![image-20200819000625738](E:\Typora\imgs\image-20200819000625738.png)

![image-20200819000734475](E:\Typora\imgs\image-20200819000734475.png)

- 目录结构

  **单级目录结构**

![image-20200819000959810](E:\Typora\imgs\image-20200819000959810.png)

 	 **两级目录结构**

![image-20200819084701078](E:\Typora\imgs\image-20200819084701078.png)

​	**多级目录结构**

![image-20200819085008981](E:\Typora\imgs\image-20200819085008981.png)

​	引入“当前目录”和“相对路径”后，可以减少磁盘的IO次数，提升文件的访问效率

​	“当前目录”意味着目录表已经调入内存，用户想找当前目录下的某个文件时候，可以从当前目录出发直接往下找，而不是从内存中先找到目录表。

​	![image-20200819085410359](E:\Typora\imgs\image-20200819085410359.png)

 **无环图目录结构**

![image-20200819090540844](E:\Typora\imgs\image-20200819090540844.png)

**对FCB的改进---索引节点**

![image-20200819091203482](E:\Typora\imgs\image-20200819091203482.png)

当找到文件名对应的目录项后，才需要将索引节点调入内存，索引节点中记录了文件的各种信息，包括文件在外存中的存放位置，根据存放位置即可找到对应的文件。

存放在外存的索引节点称为**磁盘索引节点**，当索引节点放入内存，称为**内存索引节点**。相比之下，内存索引节点需要增加几个额外信息，比如文件是否修改过，有几个进程正在访问该文件等。

![image-20200819091640883](E:\Typora\imgs\image-20200819091640883.png)

#### 文件的物理结构（文件分配方式）

![image-20200819091904299](E:\Typora\imgs\image-20200819091904299.png)

##### ![image-20200819092123683](E:\Typora\imgs\image-20200819092123683.png)

几个补充知识

​	**磁盘块，文件块**

![image-20200819092622313](E:\Typora\imgs\image-20200819092622313.png)

![image-20200819092842620](E:\Typora\imgs\image-20200819092842620.png)

##### 文件分配方式

​	这里是对非空闲磁盘块的管理

​	**连续分配**

![image-20200819093116252](E:\Typora\imgs\image-20200819093116252.png)

![image-20200819093246563](E:\Typora\imgs\image-20200819093246563.png)

![image-20200819093328919](E:\Typora\imgs\image-20200819093328919.png)

![image-20200819093433054](E:\Typora\imgs\image-20200819093433054.png)

总结：

连续分配方式需要每个文件在磁盘上占有一组连续的块

优点：支持顺序访问和随机访问；连续分配的文件在顺序访问是速度最快（磁头寻址时间最短）

缺点：不方便文件扩展；存储空间利用率低，会产生磁盘碎片，类似于内存中的外部碎片。

**链接分配**

​	隐式链接

![image-20200819094440412](E:\Typora\imgs\image-20200819094440412.png) 

![image-20200819094712728](E:\Typora\imgs\image-20200819094712728.png)



​	显示链接

![image-20200819095255937](E:\Typora\imgs\image-20200819095255937.png)

![image-20200819095548882](E:\Typora\imgs\image-20200819095548882.png)

![image-20200819095608095](E:\Typora\imgs\image-20200819095608095.png)

**索引分配**

![image-20200819100238326](E:\Typora\imgs\image-20200819100238326.png)	如何实现逻辑块号到物理块号的转换呢？

从目录项中找到索引的存放位置 ---- >  索引表读入内存 ---->  查找索引表即可得到i号逻辑块在外存中的位置

所以，索引分配是<font color = red>支持随机访问的，文件拓展也容易实现</font>（只需分配一个新的空闲块，然后增加一个索引表项即可），但是<font color = red>索引表需要占有一定的存储空间</font>

![image-20200819100851249](E:\Typora\imgs\image-20200819100851249.png)

![image-20200819101505291](E:\Typora\imgs\image-20200819101505291.png)

![image-20200819101858571](E:\Typora\imgs\image-20200819101858571.png)

![image-20200819102252600](E:\Typora\imgs\image-20200819102252600.png)

![image-20200819102609823](E:\Typora\imgs\image-20200819102609823.png)

![image-20200819102621176](E:\Typora\imgs\image-20200819102621176.png)

##### 文件存储空间管理

​	是对空闲磁盘块的管理

![image-20200819102741194](E:\Typora\imgs\image-20200819102741194.png)

**存储空间的划分与初始化**

![image-20200819102922499](E:\Typora\imgs\image-20200819102922499.png)

**存储空间管理**

​	空闲表法

![image-20200819104002915](E:\Typora\imgs\image-20200819104002915.png)

空闲链表法， 又分为空闲盘块链和空闲盘区链

![image-20200819104112438](E:\Typora\imgs\image-20200819104112438.png)

​			空闲盘块链

![image-20200819104210551](E:\Typora\imgs\image-20200819104210551.png)

​	空闲盘区链

![image-20200819104453013](E:\Typora\imgs\image-20200819104453013.png)

位示图法

![image-20200819104746343](E:\Typora\imgs\image-20200819104746343.png)

![image-20200819104901731](E:\Typora\imgs\image-20200819104901731.png)

成组链接法 

![image-20200819105001944](E:\Typora\imgs\image-20200819105001944.png)

![image-20200819105304292](E:\Typora\imgs\image-20200819105304292.png)

注意，分组的第一个磁盘快，需要记录下一组空闲磁盘块的相关信息:下一组空闲盘块数和对应的空闲块号

![image-20200819105918487](E:\Typora\imgs\image-20200819105918487.png)

超级块就相当于一个链头的作用，保存了指向下一个分组的信息

回收：第一个分组满了和没满两种情况

![image-20200819110129139](E:\Typora\imgs\image-20200819110129139.png)

 

![image-20200819110145535](E:\Typora\imgs\image-20200819110145535.png)

比如回收的是201， 只需要在 分组末尾更新201，并增加指向块号为201的链接即可

#### 文件基本操作

![image-20200819140203051](E:\Typora\imgs\image-20200819140203051.png)

**创建文件**

![image-20200819141026634](E:\Typora\imgs\image-20200819141026634.png)

**删除文件**

![image-20200819141137820](E:\Typora\imgs\image-20200819141137820.png)

![image-20200819141845256](E:\Typora\imgs\image-20200819141845256.png)

**打开文件**

![image-20200819142046473](E:\Typora\imgs\image-20200819142046473.png)

**关闭文件**

![image-20200819142256349](E:\Typora\imgs\image-20200819142256349.png)**读文件**

![image-20200819142645178](E:\Typora\imgs\image-20200819142645178.png)

**写文件**

 ![image-20200819142728629](E:\Typora\imgs\image-20200819142728629.png)

![image-20200819143007421](E:\Typora\imgs\image-20200819143007421.png)

#### 文件共享

![image-20200820095015037](E:\Typora\imgs\image-20200820095015037.png)

![image-20200820095518499](E:\Typora\imgs\image-20200820095518499.png)

![image-20200820095731804](E:\Typora\imgs\image-20200820095731804.png)

这个link文件就是windows中的快捷方式

![image-20200820095843009](E:\Typora\imgs\image-20200820095843009.png)

软链接删除文件：

![image-20200820100006853](E:\Typora\imgs\image-20200820100006853.png)

![image-20200820100117767](E:\Typora\imgs\image-20200820100117767.png)

因此软链接访问共享文件的速度要比硬链接慢

#### 文件保护

	- 口令保护

![image-20200820100251243](E:\Typora\imgs\image-20200820100251243.png)

- 加密保护

![image-20200820100546030](E:\Typora\imgs\image-20200820100546030.png)

- 访问控制

![image-20200820101048098](E:\Typora\imgs\image-20200820101048098.png)

![image-20200820101114474](E:\Typora\imgs\image-20200820101114474.png)

#### 文件系统层次结构

![image-20200820101955695](E:\Typora\imgs\image-20200820101955695.png)

![image-20200820102137444](E:\Typora\imgs\image-20200820102137444.png)

#### 磁盘

##### 磁盘结构![image-20200820102156780](E:\Typora\imgs\image-20200820102156780.png)

![image-20200820102828119](E:\Typora\imgs\image-20200820102828119.png)

如果读写数据？需要把磁头移动到想要读写的扇区所在的磁道。磁盘会转起来，让目标扇区从磁头下划过，就能完成读/写操作

![image-20200820103317104](E:\Typora\imgs\image-20200820103317104.png)

柱面号就是确定哪一个磁道，盘面号确定在哪个盘面，扇区号确定哪个扇区。

##### 磁盘分类

- 磁头是否可以移动

![image-20200820103545845](E:\Typora\imgs\image-20200820103545845.png)

- 盘片是否可以更换

![image-20200820103558653](E:\Typora\imgs\image-20200820103558653.png)

##### 磁盘调度算法

![image-20200820103705449](E:\Typora\imgs\image-20200820103705449.png)

- 一次磁盘读/写操作需要的时间

  ![image-20200820104435010](E:\Typora\imgs\image-20200820104435010.png)

  现在的磁盘移动一个磁道大概需要0.2ms，磁臂启动时间约2ms

  磁盘的典型转速为5400rpm ，7200rpm

几种调度算法

- FCFS 先来先服务算法

![image-20200820104707094](E:\Typora\imgs\image-20200820104707094.png)

- SSTF 最短寻找时间优先

![image-20200820105309704](E:\Typora\imgs\image-20200820105309704.png)

- 扫描算法  SCAN

  ![image-20200820105555987](E:\Typora\imgs\image-20200820105555987.png)

- LOOK调度算法

  ![image-20200820105657060](E:\Typora\imgs\image-20200820105657060.png)

- 循环扫描算法  C-SCAN

![image-20200820105919010](E:\Typora\imgs\image-20200820105919010.png)

- C-LOOK算法

![image-20200820110037451](E:\Typora\imgs\image-20200820110037451.png)

 ![image-20200820110215273](E:\Typora\imgs\image-20200820110215273.png)

##### 减少延迟时间的方法

![image-20200820110420030](E:\Typora\imgs\image-20200820110420030.png)

**交替编号**

![image-20200820110549360](E:\Typora\imgs\image-20200820110549360.png)

采取交替编号的形式，那么读取连续的逻辑编号的扇区时，可以减少磁盘转动一圈所需要的时间，就减少了延迟时间

![image-20200820110942852](E:\Typora\imgs\image-20200820110942852.png)

 ![image-20200820111231690](E:\Typora\imgs\image-20200820111231690.png)

需要尽量减少**磁头的移动**（物理移动最耗时），而对于连续的二进制数而言，最左边的几位往往是相同的（也就是柱面号是相同的，或者说变化很少），因此移动磁头的概率就比较低；而如果采用中间的几位来记录柱面的话，变化的概率要高，产生磁头移动次数会变高。所以，采用（柱面号，盘面号，扇区号）的地址结构可以减少磁头移动的耗时

**错位命名**

![image-20200820112118596](E:\Typora\imgs\image-20200820112118596.png)

示意图： 举例读的是物理地址为0 - 8的所有数据

![image-20200820112608545](E:\Typora\imgs\image-20200820112608545.png)

![image-20200820112637473](E:\Typora\imgs\image-20200820112637473.png)

交替编号和错位编号都是基于，读取玩一个扇区后，需要一段处理时间才能继续读入下一个扇区；所以提出对应的改进方法。

##### 磁盘管理

- 磁盘的初始化

  ![image-20200820132710631](E:\Typora\imgs\image-20200820132710631.png)·圈

- 引导块

  ![image-20200820133402692](E:\Typora\imgs\image-20200820133402692.png)

- 坏块

![image-20200820133643735](E:\Typora\imgs\image-20200820133643735.png)



## IO设备

![image-20200820133825967](E:\Typora\imgs\image-20200820133825967.png)

#### IO设备

​	![image-20200820134000804](E:\Typora\imgs\image-20200820134000804.png)

IO设备的分类

![image-20200820134107563](E:\Typora\imgs\image-20200820134107563.png)

![image-20200820134118832](E:\Typora\imgs\image-20200820134118832.png)

![image-20200820134201557](E:\Typora\imgs\image-20200820134201557.png)

#### ![image-20200820134252025](E:\Typora\imgs\image-20200820134252025.png)



#### IO控制器

​	![image-20200820134452885](E:\Typora\imgs\image-20200820134452885.png)

![image-20200820135115228](E:\Typora\imgs\image-20200820135115228.png)

每一种寄存器可能还有多个

- IO控制器的组成	

![image-20200820135509549](E:\Typora\imgs\image-20200820135509549.png)

一个IO控制器可能对一个多个设备，所以同类寄存器会有多个，且这些寄存器要有相应的地址才能方便CPU操作。有的计算机会让这些寄存器占用内存地址的一部分，称为<font color = red>内存映像IO</font>, 有的计算机采用I/O专用地址，即<font color = red>寄存器独立编址</font>(统一编址 && 独立编址)

![image-20200820140011266](E:\Typora\imgs\image-20200820140011266.png)

![image-20200820140121256](E:\Typora\imgs\image-20200820140121256.png)

#### IO控制方式

![image-20200820140209636](E:\Typora\imgs\image-20200820140209636.png)

**程序直接控制方式**

![image-20200820141705036](E:\Typora\imgs\image-20200820141705036.png)

![image-20200820142015539](E:\Typora\imgs\image-20200820142015539.png)

![image-20200820142156087](E:\Typora\imgs\image-20200820142156087.png)

**中断驱动方式**

![image-20200820142418452](E:\Typora\imgs\image-20200820142418452.png)

![image-20200820142526962](E:\Typora\imgs\image-20200820142526962.png)

**DMA方式**  

![image-20200820142657395](E:\Typora\imgs\image-20200820142657395.png)

![image-20200820143059608](E:\Typora\imgs\image-20200820143059608.png)

![image-20200820143249860](E:\Typora\imgs\image-20200820143249860.png)

如果要读离散的数据块的话，就需要CPU发送多条IO指令

**通道控制方式**

![image-20200820143541755](E:\Typora\imgs\image-20200820143541755.png)

![image-20200820143639067](E:\Typora\imgs\image-20200820143639067.png)

![image-20200820143742816](E:\Typora\imgs\image-20200820143742816.png)

一个通道可以控制多个IO控制器，一个IO控制器可以控制多个IO设备

#### IO软件层次结构

![image-20200820201527640](E:\Typora\imgs\image-20200820201527640.png)

![image-20200820202059013](E:\Typora\imgs\image-20200820202059013.png)

设备独立性软件提供的功能

- 向上层提供统一的调用接口（read/write等系统调用）
- 设备的保护

![image-20200820202326443](E:\Typora\imgs\image-20200820202326443.png)

- 差错处理

  对设备产生的错误进行处理

- 设备的分配与回收

  很多设备是临界资源，因此OS肯定都要对这些设备进行管理

- 数据缓冲区管理

- 建立逻辑设备名到物理设备名的映射关系；根据设备类型选择调用对应的驱动程序

![image-20200820202543598](E:\Typora\imgs\image-20200820202543598.png)

![image-20200820202715534](E:\Typora\imgs\image-20200820202715534.png)

![image-20200820202903949](E:\Typora\imgs\image-20200820202903949.png)

![image-20200820203029205](E:\Typora\imgs\image-20200820203029205.png)

![image-20200820203155692](E:\Typora\imgs\image-20200820203155692.png)

![image-20200820203411776](E:\Typora\imgs\image-20200820203411776.png)

#### IO核心子系统

![image-20200820203508757](E:\Typora\imgs\image-20200820203508757.png)

![image-20200820205315620](E:\Typora\imgs\image-20200820205315620.png)

![image-20200820205409785](E:\Typora\imgs\image-20200820205409785.png)

![image-20200820205449882](E:\Typora\imgs\image-20200820205449882.png)

##### 假脱机技术

![image-20200820205600566](E:\Typora\imgs\image-20200820205600566.png)	![image-20200820210335292](E:\Typora\imgs\image-20200820210335292.png)

![image-20200820210459906](E:\Typora\imgs\image-20200820210459906.png)

![image-20200820210559760](E:\Typora\imgs\image-20200820210559760.png)

输出井， 输入井相当于磁带

![image-20200820210757683](E:\Typora\imgs\image-20200820210757683.png)

![image-20200820211235310](E:\Typora\imgs\image-20200820211235310.png)

虽然系统各种只有一台打印机，但是当进程提出打印请求时，系统会为每个进程在输出井中分配一个存储区（相当于分配了一个逻辑设备），使每个进程都觉得自己独占了一台打印机，从而实现了对打印机的共享。

SPOOLING技术可以一台物理设备虚拟成逻辑上的多台设备，<font color =red>可以将独占式设备改造成共享设备</font>

![image-20200820211432865](E:\Typora\imgs\image-20200820211432865.png)

##### 设备的分配与回收

![image-20200820211645871](E:\Typora\imgs\image-20200820211645871.png)

![image-20200820211912903](E:\Typora\imgs\image-20200820211912903.png)

**静态分配**   进程运行前为其分配所需的所有资源，运行结束后归还。 （破坏了请求与保持条件）

**动态分配**   进程运行过程中动态申请设备资源

![image-20200820212556236](E:\Typora\imgs\image-20200820212556236.png)

![image-20200820212734843](E:\Typora\imgs\image-20200820212734843.png)

进程如果在等待某个IO设备的分配，而这个IO设备又没法分配给这个进程时，那么这个进程PCB就会挂在这个IO设备控制表所指向的等待队列的队尾

![image-20200820213003153](E:\Typora\imgs\image-20200820213003153.png)

![image-20200820213048600](E:\Typora\imgs\image-20200820213048600.png)

![image-20200820213128889](E:\Typora\imgs\image-20200820213128889.png)

![image-20200820213321401](E:\Typora\imgs\image-20200820213321401.png)![image-20200820213547614](E:\Typora\imgs\image-20200820213547614.png)

![image-20200820213554249](E:\Typora\imgs\image-20200820213554249.png)

##### 缓冲区管理

![image-20200820214007340](E:\Typora\imgs\image-20200820214007340.png)

![image-20200820214245098](E:\Typora\imgs\image-20200820214245098.png)

![image-20200820214451133](E:\Typora\imgs\image-20200820214451133.png)

![image-20200820214716150](E:\Typora\imgs\image-20200820214716150.png)

![image-20200820215103157](E:\Typora\imgs\image-20200820215103157.png)

![image-20200820215354227](E:\Typora\imgs\image-20200820215354227.png)

![image-20200820215709193](E:\Typora\imgs\image-20200820215709193.png)

![image-20200820215825006](E:\Typora\imgs\image-20200820215825006.png)

![image-20200820220030244](E:\Typora\imgs\image-20200820220030244.png)